<!DOCTYPE html>
<html  lang="en" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="ISO-8859-1">
<title>Insert title here</title>
<link rel="stylesheet" th:href="@{/lib/bootstrap/css/bootstrap.min.css}" />
<script th:src="@{/lib/bootstrap/js/bootstrap.min.js}"></script>

<style>
#sentBackUpdateTable tr:nth-child(1){      /* this style used for auto increment Serial No in Data Table*/
 counter-reset: rowNumber;
					}
#sentBackUpdateTable tr {
 counter-increment: rowNumber;
		}
#sentBackUpdateTable tr td:first-child::before {
 content: counter(rowNumber);
min-width: 1em;
margin-right: 0.5em;
					}



#sentBackUpdateTable,thead,tr,th,td,tbody{
  border: 1px solid black;
  border-collapse: collapse;
  text-align:center;
  
}

.selected{
 background:#7FFF00;
 }

input{
  text-align:center;
}



#commentData tr:nth-child(1){      /* this style used for auto increment Serial No in Data Table*/
 counter-reset: rowNumber;
					}
#commentData tr {
 counter-increment: rowNumber;
		}
#commentData tr td:first-child::before {
 content: counter(rowNumber);
min-width: 1em;
margin-right: 0.5em;
	}
	

#commentData tr td {
    width: 350px;
     padding: 5px;
     border:none !important;
    text-align:justify;
    word-spacing: -2px;
    white-space: nowrap;
}
#commentData thead tr th {
     border:none !important;
    text-align:justify;
     word-spacing: 10px;
     white-space: nowrap;
}
 #commentData tbody{
     border:none !important;
     text-align:left;
    text-align:justify;
}

#commentData {
     border:none;
     text-align:justify;
     text-justify: inter-word;
    
} 
#commentData thead{
     border:none !important;
     text-align:left;
     text-align:justify;
   }
   
 #commentData tr:hover{
  background:#F0FFF0;
  
 }
 
 
 
 #currentDeskData tr td {
    width: 350px;
     padding: 5px;
     border:none !important;
    text-align:justify;
    word-spacing: -2px;
    white-space: nowrap;
}
#currentDeskData thead tr th {
     border:none !important;
    text-align:justify;
     word-spacing: 10px;
     white-space: nowrap;
}
 #currentDeskData tbody{
     border:none !important;
     text-align:left;
    text-align:justify;
}

#currentDeskData {
     border:none;
     text-align:justify;
     text-justify: inter-word;
    
} 
#currentDeskData thead{
     border:none !important;
     text-align:left;
     text-align:justify;
   }

</style>

</head>
<body>
<h1 style="margin-left:300px;">Sent Back Application Update Form</h1>

      
		<div style="margin-left:20px;"> Remarks</div>
		<textarea name="textarea" id="comment" style="width:500px; height:50px; margin-left:20px; "></textarea>
		
		<br>


<table border="1" style=" margin-left:20px; overflow-x:auto; border-collapse: collapse;" id="invTable">
<tr>
<th>Invoice No</th>
<th  th:text="${invoiceNo}"  id="invoiceNo" style=" margin-left:20px; font-family: Arial, Helvetica, sans-serif; font-size:18pt;"> </th>
</tr>


</table >
<br>
<table id="sentBackUpdateTable"  style="width: 80%; margin-left:20px; overflow-x:auto;">

                <thead>
                <tr>
                   <th >SL</th>
                    <th>Brand Name</th>
                    <th>Product Name</th>
                    <th>Product Details</th>
                    <th>Product Code</th>
                    <th>Quantity</th>
                    <th>Purchases Price</th>
                    <th>Sub-Total</th>
                    <th>Selling Price</th>
                    <th>Selling Sub</th>
                    <th>Price Key</th>
                    <th>Unit of Quantity</th>
                     
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${plist}">
                      <td id="sl"></td>
                       
	                  <td  class="brandName" th:text="${p.brandInfo.brandName}"></td>
	                  <td  class="productName" th:text="${p.productInfo.productName}"></td> 
					  <td  class="catagoryName" th:text="${p.catagoryInfo.catagoryName}"></td> 
					  <td  class="productId" th:text="${p.catagoryProductId}"></td> 
					  <td ><input type="text" style="border:none;font-weight:bold; height:50px;" class="quantity"th:value="${p.productQuanity}"/></td> 
					  <td ><input type="text" class="purchase" style="border:none;font-weight:bold; height:50px;" th:value="${p.purchasePrice}"/></td> 
					  <td  class="subtotal"></td> 
					  <td ><input type="text" class="sellingPrice" style="border:none;font-weight:bold; height:50px;" th:value="${p.sellingPrice}"/></td>
					  <td  class="sellingSub"></td>
					  <td  class="priceKey" th:text="${p.priceKey}"></td>
					  <td  ><input type="text" class="unitOfQuantity" style="border:none;font-weight:bold; height:50px;" th:value="${p.unitOfQuanity}"/></td>
					  
					  
					  
                  
                </tr>
               
                <tfoot>
                <tr>
               <th colspan="5">Total:</th><th id="q"> </th><td ></td><th id="gtotal"></th><th></th><th colspan="1" id="sellingTotal"></th>
                </tr>
                </tfoot>
                
                </tbody>
               
           </table>
           <br/>
            <input type="button" class="btn btn-primary btn-lg" id="sentBackUpdate" value="Update" style="margin-left:450px; width:200px;"/>
           
           
           
           <br>
            <hr>
            <table id="currentDeskData"  style="margin-left:20px;  overflow-x:auto;">
            <thead>
            
            </thead>
            <tbody>
            
            </tbody>
            
            </table>
            
           
           <br>
            <hr> <hr>
              <div style="margin-left:60px; font-size:12px; font-weight:bold;">History</div>
            <table  id="commentData" style="margin-left:20px;  overflow-x:auto;">
           
             <thead>
             </thead>
             <tbody>
             
             
             </tbody>
               
            </table>
              <hr>
           
           <script th:src="@{/lib/jquery/jquery.min.js}"></script>
            <script>
             $(document).ready(function(){
            	 $(".quantity,.purchase,.sellingPrice").keyup(function(){
            		 
            		 totalQty();
            		 subCalTotal();
            		 sallingSubTotal();
            	 }); 
            	 totalQty();
            	 subCalTotal();
            	 
            	 sallingSubTotal();
            	 
      //..............................end.......................................//      	 
            	 
            	
            	   
            
          	
           	var TableData = [];
           	$('#sentBackUpdateTable tbody tr').each(function(row, tr){
           	    TableData[row]={
           	    	 "catagoryProductId" : $(tr).find('td:eq(4)').text(),
           	         "productQuanity" :$(this).closest('tr').find('td:eq(5)').find('.quantity').val(),
           	         "purchasePrice" : $(this).closest('tr').find('td:eq(6)').find('.purchase').val() ,
           	         "sellingPrice" :$(this).closest('tr').find('td:eq(8)').find('.sellingPrice').val(),
           	         "priceKey" : $(tr).find('td:eq(10)').text(),
           	         "unitOfQuantity" :$(this).closest('tr').find('td:eq(11)').find('.unitOfQuantity').val()
           	        
           	    }
           	}); 
           //	TableData.shift(); 
           console.log("Qty : ",$(this).closest('tr').find('td:eq(5)').find('.quantity').val());
           	console.log("tabledata : ",TableData);
           	//.........save stocks method call here.............//
           	 $("#sentBackUpdate").on("click",function(e){
           		e.preventDefault();

           		
           		

              
               	   var arr=[];
               	$('#sentBackUpdateTable tbody tr').each(function(row, tr){
               		arr[row]={
               	        "catagoryProductId" : $(tr).find('td:eq(4)').text()
               	        , "productQuanity" :$(tr).find(".quantity").val()
               	        , "purchasePrice" : $(tr).find(".purchase").val()
               	        , "sellingPrice" : $(tr).find(".sellingPrice").val()
               	        , "priceKey" : $(tr).find('td:eq(10)').text()
               	        , "unitOfQuanity" : $(tr).find('.unitOfQuantity').val()
               	    }
               	}); 
               	console.log("arr  :: ",arr);
           		UpdatePurchase(arr);
           		
           		$(this).attr("disabled",true);
           		$(this).val("Updated");
           		$(this).css({
           		   'background-color':'#555555', 
           		   'color':'white', 
           		   'display':'block',
           		   
           		});
           		$("#sentBackUpdateTable").hide();
           		$("#invTable").hide();
           		
            }); 
           	
           	commentsList(); //sho history
           	currentDesk(); //show current desk
             });
             
             
           //.................................Start Selected Background color...............................................//  
             function selectRow(){  //When selected row background color change will be selected .
     			var index;
     			var table=document.getElementById("sentBackUpdateTable");
     			
     			for(var i =1; i<table.rows.length; i++){
     				table.rows[i].onclick = function(){
     				 if(typeof index !== 'undefined'){
     					 table.rows[index].classList.toggle("selected");
     					 
     				 }
     				
     					index=this.rowIndex;
     					this.classList.toggle("selected");
     					console.log(index);
     				};
     			}
     			
     		}
             selectRow();
             
   //.......................................start saving stocks....................................................................//        
        		   
          
           //Update here stock product by ajax
     		function UpdatePurchase(arr) {
     			 var invoiceNo=$("#invoiceNo").text();
                 var comment=$("#comment").val();
                 
                 
                  url='';
                  if(comment){ 
   					 url =`/p/update_sentBack_application/${invoiceNo}/${comment}`
   				 }else{
   					url =`/p/update_sentBack_application/${invoiceNo}/${null}`
   				} 
     			$.ajax({
     				url:url,
     				type : 'put',
     				data: JSON.stringify(arr),
     			    contentType: "application/json; charset=utf-8",
     				success : function(response) {
     					alert("Update Successfully ");
     					
     					
     				},
     				error : function() {
     					alert("an Error Occured");
     				}
     			});
     		}
              function totalQty(){
            	  var totalQuantity=0;  // Here sum of quantity
             	 $('#sentBackUpdateTable tbody tr').each(function(){
             			var qty= $(this).closest('tr').find('td:eq(5)').find('.quantity').val();
             			console.log("qty",qty);
             			 if(qty.length !=0){
             				 totalQuantity+=Number(qty);
                 		 }
             		
             		 
             	 });
             	 console.log(totalQuantity);
             	$("#q").text(totalQuantity);
             	
              }
              
              
              function subCalTotal(){
            	    var subTotal=0;
    				var gtotal = 0;
          	        var arr=[];
          	   // Here Multiply Quantity and Purchase price
          	 $('#sentBackUpdateTable tbody tr').each(function(){
      			 var currRow = $(this);
      			
      			var qty= $(this).closest('tr').find('td:eq(5)').find('.quantity').val();
      			var purchase= $(this).closest('tr').find('td:eq(6)').find('.purchase').val();
      			 
      			// console.log("q: " + quantity + " || p: " + purchase)
      			 
      			 subTotal = parseInt(purchase) * parseInt(qty);
      			 
      			 if (subTotal > 0) {
      				 gtotal += subTotal
      			 } 
      			 
      			// console.log("subTotal: " + subTotal);
      			 currRow.find(".subtotal").text(subTotal);
      			 arr.push(subTotal);
      			 
          		 
          	 });
          	   $("#gtotal").text(gtotal);
              }
              
              
              
              
    //.............................saling sub-total..................................//    
              function sallingSubTotal(){
            	   var subTotal=0;
    				var gtotal = 0;
          	 var arr=[];
          	   // Here Multiply Quantity and Selling Price
          	  $('#sentBackUpdateTable tbody tr').each(function(){
      			 var currRow = $(this);
      			var qty= $(this).closest('tr').find('td:eq(5)').find('.quantity').val();
      			var sallingPrice= $(this).closest('tr').find('td:eq(8)').find('.sellingPrice').val();
      			
      			 
      			// console.log("q: " + quantity + " || p: " + sellingPrice)
      			 
      			 subTotal = parseInt(sallingPrice) * parseInt(qty);
      			 
      			 if (subTotal > 0) {
      				 gtotal += subTotal
      			 } 
      			 
      			// console.log("subTotal: " + subTotal);
      			 currRow.find(".sellingSub").text(subTotal);
      			 arr.push(subTotal);
      			 
          		 
          	 });
          	  $("#sellingTotal").text(gtotal);
              }
    
    
              function commentsList(){
             	 var inv= $("#invoiceNo").text();
  				console.log("inv 2",inv);
  				$.ajax({
       				url : '/comment/commentList/'+inv,
       				type : 'GET',
       			    contentType: "application/json",
       				success : function(response) {
       					  var tableThead=$('#commentData thead');
       				      tableThead.empty();
       					  const th="<tr  style='background:#98FB98; border:none;'>"+"<th>"+"#"+"</th>"+"<th>"+"Status"+"</th>"+"<th>"+"Comments"+"</th>"+"<th>"+"Process Time"+"</th>"+"</tr>";
       					  tableThead.append(th);
       					 $.each(response,function(key, value){
       						  var tableBody=$('#commentData tbody');
       					      tableBody.append('<tr style="border:none;"><td style="width:10px;">'+"."+'</td> <td>' +value.status + '</td> <td>' + value.comments + '</td><td>' + value.processTime + '</td> </tr>');
       					    
       					}); 
       					
       					
       				},
       				error : function() {
       					alert("an Error Occured");
       				}
       			});
              }
              
              
              
              function currentDesk(){
             	 var invoice=$("#invoiceNo").text();
  				console.log("invoice vv",invoice);
  				$.ajax({
       				url : `/currentDesk/curent_status/${invoice}`,
       				type : 'GET',
       			    contentType: "application/json",
       				success : function(response) {
       					  var tableThead=$('#currentDeskData thead');
       				      tableThead.empty();
       					  const th="<tr  style='background:#98FB98; border:none;'>"+"<th>"+"Currend Desk"+"</th>"+"</tr>";
       					  tableThead.append(th);
       					 $.each(response,function(key, value){
       						  var tableBody=$('#currentDeskData tbody');
       					      tableBody.append('<tr style="border:none;"> <td>' +value.currentDesk + '</td></tr>');
       					    
       					}); 
       					
       					
       				},
       				error : function() {
       					alert("an Sent Back Update Error");
       				}
       			});
              }
       </script>
</body>
</html>